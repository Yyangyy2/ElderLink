<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/.env">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/.env" />
              <option name="updatedContent" value="GEMINI_API_KEY=AIzaSyDcoS_TkV47a7227n9hqIxhFx1LIZ3djWE&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/.env.example">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/.env.example" />
              <option name="originalContent" value="# Example .env for ElderLink&#10;# Copy this to .env and fill in your real keys locally (do NOT commit .env)&#10;GEMINI_API_KEY=REPLACE_WITH_YOUR_KEY&#10;" />
              <option name="updatedContent" value="# Example .env for ElderLink&#10;# Copy this to .env and fill in your real keys locally (do NOT commit .env)&#10;GEMINI_API_KEY=REPLACE_WITH_YOUR_KEY&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/.gitignore">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/.gitignore" />
              <option name="originalContent" value="*.iml&#10;.gradle&#10;/local.properties&#10;/.idea/caches&#10;/.idea/libraries&#10;/.idea/modules.xml&#10;/.idea/workspace.xml&#10;/.idea/navEditor.xml&#10;/.idea/assetWizardSettings.xml&#10;.DS_Store&#10;/build&#10;/captures&#10;.externalNativeBuild&#10;.cxx&#10;local.properties&#10;" />
              <option name="updatedContent" value="*.iml&#10;.gradle&#10;/local.properties&#10;/.idea/caches&#10;/.idea/libraries&#10;/.idea/modules.xml&#10;/.idea/workspace.xml&#10;/.idea/navEditor.xml&#10;/.idea/assetWizardSettings.xml&#10;/.idea/assetWizardSettings.xml&#10;.DS_Store&#10;/build&#10;/captures&#10;.externalNativeBuild&#10;.cxx&#10;local.properties&#10;&#10;# Environment file with secrets&#10;.env" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/build.gradle.kts">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/build.gradle.kts" />
              <option name="originalContent" value="plugins {&#10;    alias(libs.plugins.android.application)&#10;    alias(libs.plugins.kotlin.android)&#10;    alias(libs.plugins.kotlin.compose)&#10;    alias(libs.plugins.google.gms.google.services)&#10;}&#10;&#10;android {&#10;    namespace = &quot;com.example.elderlink&quot;&#10;    compileSdk = 35&#10;&#10;    defaultConfig {&#10;        applicationId = &quot;com.example.elderlink&quot;&#10;        minSdk = 26&#10;        targetSdk = 35&#10;        versionCode = 1&#10;        versionName = &quot;1.0&quot;&#10;&#10;        testInstrumentationRunner = &quot;androidx.test.runner.AndroidJUnitRunner&quot;&#10;    }&#10;&#10;    buildTypes {&#10;        debug {&#10;            // prevent debug suffix&#10;            applicationIdSuffix = &quot;&quot;&#10;            versionNameSuffix = &quot;&quot;&#10;        }&#10;        release {&#10;            isMinifyEnabled = false&#10;            proguardFiles(&#10;                getDefaultProguardFile(&quot;proguard-android-optimize.txt&quot;),&#10;                &quot;proguard-rules.pro&quot;&#10;            )&#10;            signingConfig = signingConfigs.getByName(&quot;debug&quot;)&#10;        }&#10;    }&#10;    compileOptions {&#10;        sourceCompatibility = JavaVersion.VERSION_11&#10;        targetCompatibility = JavaVersion.VERSION_11&#10;    }&#10;    kotlinOptions {&#10;        jvmTarget = &quot;11&quot;&#10;    }&#10;    buildFeatures {&#10;        compose = true&#10;    }&#10;}&#10;&#10;dependencies {&#10;&#10;    implementation(libs.androidx.core.ktx)&#10;    implementation(libs.androidx.lifecycle.runtime.ktx)&#10;    implementation(libs.androidx.activity.compose)&#10;    implementation(platform(libs.androidx.compose.bom))&#10;    implementation(libs.androidx.ui)&#10;    implementation(libs.androidx.ui.graphics)&#10;    implementation(libs.androidx.ui.tooling.preview)&#10;    implementation(libs.androidx.material3)&#10;    implementation(libs.firebase.database)&#10;    implementation(libs.androidx.appcompat)&#10;    implementation(libs.androidx.constraintlayout)&#10;    implementation(libs.firebase.auth)&#10;    implementation(libs.androidx.recyclerview)&#10;    implementation(libs.material)&#10;    implementation(&quot;com.github.bumptech.glide:glide:4.16.0&quot;)&#10;    implementation(libs.firebase.storage)&#10;    implementation(libs.firebase.firestore)&#10;    annotationProcessor(&quot;com.github.bumptech.glide:compiler:4.16.0&quot;)&#10;    //implementation (&quot;com.google.ai.client:generativelanguage:0.7.0&quot;)&#10;    implementation (&quot;com.squareup.okhttp3:okhttp:4.11.0&quot;)&#10;    implementation (&quot;com.google.code.gson:gson:2.10.1&quot;)&#10;    implementation (&quot;com.squareup.picasso:picasso:2.71828&quot;)&#10;    implementation (&quot;com.google.firebase:firebase-messaging:23.4.1&quot;)&#10;&#10;&#10;&#10;&#10;&#10;    testImplementation(libs.junit)&#10;    androidTestImplementation(libs.androidx.junit)&#10;    androidTestImplementation(libs.androidx.espresso.core)&#10;    androidTestImplementation(platform(libs.androidx.compose.bom))&#10;    androidTestImplementation(libs.androidx.ui.test.junit4)&#10;    debugImplementation(libs.androidx.ui.tooling)&#10;    debugImplementation(libs.androidx.ui.test.manifest)&#10;}" />
              <option name="updatedContent" value="plugins {&#10;    alias(libs.plugins.android.application)&#10;    alias(libs.plugins.kotlin.android)&#10;    alias(libs.plugins.kotlin.compose)&#10;    alias(libs.plugins.google.gms.google.services)&#10;}&#10;&#10;// Load .env properties (optional) so sensitive keys can be stored outside VCS&#10;val envFile = rootProject.file(&quot;.env&quot;)&#10;val geminiApiKeyFromEnv: String? = if (envFile.exists()) {&#10;    envFile.readLines()&#10;        .map { it.trim() }&#10;        .firstOrNull { it.startsWith(&quot;GEMINI_API_KEY=&quot;) }&#10;        ?.substringAfter(&quot;=&quot;)&#10;} else null&#10;val geminiApiKey: String? = geminiApiKeyFromEnv ?: System.getenv(&quot;GEMINI_API_KEY&quot;)&#10;&#10;android {&#10;    namespace = &quot;com.example.elderlink&quot;&#10;    compileSdk = 35&#10;&#10;    defaultConfig {&#10;        applicationId = &quot;com.example.elderlink&quot;&#10;        minSdk = 26&#10;        targetSdk = 35&#10;        versionCode = 1&#10;        versionName = &quot;1.0&quot;&#10;&#10;        testInstrumentationRunner = &quot;androidx.test.runner.AndroidJUnitRunner&quot;&#10;&#10;        // Expose the GEMINI API key to the app via BuildConfig (empty string if not provided)&#10;        buildConfigField(&quot;String&quot;, &quot;GEMINI_API_KEY&quot;, &quot;\&quot;${geminiApiKey ?: &quot;&quot;}\&quot;&quot;)&#10;    }&#10;&#10;    buildTypes {&#10;        debug {&#10;            // prevent debug suffix&#10;            applicationIdSuffix = &quot;&quot;&#10;            versionNameSuffix = &quot;&quot;&#10;        }&#10;        release {&#10;            isMinifyEnabled = false&#10;            proguardFiles(&#10;                getDefaultProguardFile(&quot;proguard-android-optimize.txt&quot;),&#10;                &quot;proguard-rules.pro&quot;&#10;            )&#10;            signingConfig = signingConfigs.getByName(&quot;debug&quot;)&#10;        }&#10;    }&#10;    compileOptions {&#10;        sourceCompatibility = JavaVersion.VERSION_11&#10;        targetCompatibility = JavaVersion.VERSION_11&#10;    }&#10;    kotlinOptions {&#10;        jvmTarget = &quot;11&quot;&#10;    }&#10;    buildFeatures {&#10;        compose = true&#10;        buildConfig = true&#10;    }&#10;}&#10;&#10;dependencies {&#10;&#10;    implementation(libs.androidx.core.ktx)&#10;    implementation(libs.androidx.lifecycle.runtime.ktx)&#10;    implementation(libs.androidx.activity.compose)&#10;    implementation(platform(libs.androidx.compose.bom))&#10;    implementation(libs.androidx.ui)&#10;    implementation(libs.androidx.ui.graphics)&#10;    implementation(libs.androidx.ui.tooling.preview)&#10;    implementation(libs.androidx.material3)&#10;    implementation(libs.firebase.database)&#10;    implementation(libs.androidx.appcompat)&#10;    implementation(libs.androidx.constraintlayout)&#10;    implementation(libs.firebase.auth)&#10;    implementation(libs.androidx.recyclerview)&#10;    implementation(libs.material)&#10;    implementation(&quot;com.github.bumptech.glide:glide:4.16.0&quot;)&#10;    implementation(libs.firebase.storage)&#10;    implementation(libs.firebase.firestore)&#10;    annotationProcessor(&quot;com.github.bumptech.glide:compiler:4.16.0&quot;)&#10;    //implementation (&quot;com.google.ai.client:generativelanguage:0.7.0&quot;)&#10;    implementation (&quot;com.squareup.okhttp3:okhttp:4.11.0&quot;)&#10;    implementation (&quot;com.google.code.gson:gson:2.10.1&quot;)&#10;    implementation (&quot;com.squareup.picasso:picasso:2.71828&quot;)&#10;    implementation (&quot;com.google.firebase:firebase-messaging:23.4.1&quot;)&#10;&#10;&#10;&#10;&#10;&#10;    testImplementation(libs.junit)&#10;    androidTestImplementation(libs.androidx.junit)&#10;    androidTestImplementation(libs.androidx.espresso.core)&#10;    androidTestImplementation(platform(libs.androidx.compose.bom))&#10;    androidTestImplementation(libs.androidx.ui.test.junit4)&#10;    debugImplementation(libs.androidx.ui.tooling)&#10;    debugImplementation(libs.androidx.ui.test.manifest)&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/elderlink/view_Ask_Ai/ChatActivityElder.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/elderlink/view_Ask_Ai/ChatActivityElder.java" />
              <option name="originalContent" value="package com.example.elderlink.view_Ask_Ai;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;import android.util.Log;&#10;import android.view.View;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.ImageButton;&#10;import android.widget.ProgressBar;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;&#10;import com.example.elderlink.MainActivityElder;&#10;import com.example.elderlink.R;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#10;import com.google.firebase.firestore.QueryDocumentSnapshot;&#10;import com.google.gson.JsonArray;&#10;import com.google.gson.JsonObject;&#10;&#10;import okhttp3.MediaType;&#10;import okhttp3.OkHttpClient;&#10;import okhttp3.Request;&#10;import okhttp3.RequestBody;&#10;import okhttp3.Response;&#10;&#10;public class ChatActivityElder extends AppCompatActivity {&#10;&#10;    FirebaseFirestore db;&#10;    JsonArray medicationArray = new JsonArray();&#10;&#10;    EditText inputMessage;&#10;    Button btnSend;&#10;    TextView chatHistory;&#10;    ProgressBar loadingSpinner;&#10;&#10;    // Debug here: Update URL possible for newer version of gemini&#10;    private static final String GEMINI_API_KEY = &quot;AIzaSyDcoS_TkV47a7227n9hqIxhFx1LIZ3djWE&quot;;&#10;    private static final String GEMINI_URL =&#10;            &quot;https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=&quot; + GEMINI_API_KEY;&#10;&#10;&#10;&#10;    OkHttpClient client = new OkHttpClient.Builder()&#10;            .connectTimeout(30, java.util.concurrent.TimeUnit.SECONDS) //Give 30s to connect to the API&#10;            .readTimeout(60, java.util.concurrent.TimeUnit.SECONDS)  //Up to 60s to read the response&#10;            .writeTimeout(60, java.util.concurrent.TimeUnit.SECONDS) //Up to 60s to upload data&#10;            .build();&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_chat_elder);&#10;&#10;        db = FirebaseFirestore.getInstance();&#10;&#10;        inputMessage = findViewById(R.id.inputMessage);&#10;        btnSend = findViewById(R.id.btnSend);&#10;        chatHistory = findViewById(R.id.chatHistory);&#10;        loadingSpinner = findViewById(R.id.loadingSpinner);&#10;&#10;&#10;        // Get data from intent&#10;        String name = getIntent().getStringExtra(&quot;personName&quot;);&#10;        String imageBase64 = getIntent().getStringExtra(&quot;personImageBase64&quot;);&#10;        String personUid = getIntent().getStringExtra(&quot;personUid&quot;);&#10;        String uid = getIntent().getStringExtra(&quot;caregiverUid&quot;);&#10;        loadMedications(personUid);&#10;&#10;        btnSend.setOnClickListener(v -&gt; {&#10;            String userQuestion = inputMessage.getText().toString();&#10;            if (userQuestion.isEmpty()) return;&#10;&#10;            // Get today's date to help Ai know&#10;            String today = new java.text.SimpleDateFormat(&quot;yyyy-MM-dd&quot;, java.util.Locale.getDefault())&#10;                    .format(new java.util.Date());&#10;&#10;            appendChat(&quot;You: &quot; + userQuestion);&#10;&#10;            // Join all Firestore data into one string&#10;            String firestoreData = medicationArray.toString();&#10;&#10;            String prompt =&#10;                    &quot;You are a helpful and friendly medical assistant. &quot;&#10;                            + &quot;Today’s date is &quot; + today + &quot;. &quot;&#10;                            + &quot;You are given a list of medications in JSON format. &quot;&#10;                            + &quot;Each record may include: name, dosage, unit, time (24-hour format), date, endDate, repeatType, and switchReminder. &quot;&#10;                            + &quot;Answer the user’s question in a short, clear, and polite way.\n\n&quot;&#10;&#10;                            + &quot;JSON Data:\n&quot; + firestoreData + &quot;\n\n&quot;&#10;&#10;                            + &quot;User Question: &quot; + userQuestion + &quot;\n\n&quot;&#10;&#10;                            + &quot;Guidelines:\n&quot;&#10;                            + &quot;- Keep answers 1–3 sentences max.\n&quot;&#10;                            + &quot;- Be direct, but warm and supportive.\n&quot;&#10;                            + &quot;- If multiple medications apply, show them as a simple bullet list.\n&quot;&#10;                            + &quot;- For 'when' questions, always show both formats like: '14:00 (2:00 PM)'.\n&quot;&#10;                            + &quot;- For 'when' questions, use time/date/repeat info.\n&quot;&#10;                            + &quot;- For 'how much' questions, use dosage + unit.\n&quot;&#10;                            + &quot;- If the info isn’t in the data, say: 'I don’t know based on the data.'\n&quot;&#10;                            + &quot;- Never invent details not in the JSON.\n\n&quot;&#10;&#10;                            + &quot;Answer:&quot;;&#10;&#10;&#10;&#10;&#10;&#10;&#10;            callGemini(prompt);&#10;            inputMessage.setText(&quot;&quot;);&#10;        });&#10;&#10;&#10;        //Back Button (to MainPage)------------------------------------------------&#10;        ImageButton btnBack = findViewById(R.id.btnBack);&#10;&#10;        btnBack.setOnClickListener(new View.OnClickListener() {&#10;            @Override&#10;            public void onClick(View v) {&#10;                Intent intent = new Intent(ChatActivityElder.this, MainActivityElder.class);&#10;                intent.putExtra(&quot;personUid&quot;, personUid);&#10;                intent.putExtra(&quot;personName&quot;, name);&#10;                intent.putExtra(&quot;personImageBase64&quot;, imageBase64);&#10;                intent.putExtra(&quot;caregiverUid&quot;, uid);&#10;                startActivity(intent);&#10;                finish();&#10;            }&#10;        });&#10;&#10;    }&#10;&#10;    private void loadMedications(String personUid) {&#10;        if (personUid == null || personUid.isEmpty()) {&#10;            Toast.makeText(this, &quot;No person specified.&quot;, Toast.LENGTH_LONG).show();&#10;            return;&#10;        }&#10;&#10;        String userUid = getIntent().getStringExtra(&quot;caregiverUid&quot;);   //convert caregiverUid to userUid, because must follow database structure&#10;&#10;        db.collection(&quot;users&quot;)&#10;                .document(userUid)&#10;                .collection(&quot;people&quot;)&#10;                .document(personUid)&#10;                .collection(&quot;medications&quot;)&#10;                .get()&#10;                .addOnSuccessListener(query -&gt; {&#10;                    for (QueryDocumentSnapshot doc : query) {&#10;                        String name = doc.getString(&quot;name&quot;);&#10;                        String dosage = doc.getString(&quot;dosage&quot;);&#10;                        String unit = doc.getString(&quot;unit&quot;);&#10;                        String time = doc.getString(&quot;time&quot;);&#10;                        String date = doc.getString(&quot;date&quot;);&#10;                        String endDate = doc.getString(&quot;endDate&quot;);&#10;                        String repeatType = doc.getString(&quot;repeatType&quot;);&#10;                        Boolean switchReminder = doc.getBoolean(&quot;switchReminder&quot;);&#10;&#10;                        // Build JSON-style record&#10;                        JsonObject record = new JsonObject();&#10;                        record.addProperty(&quot;id&quot;, doc.getId());&#10;                        record.addProperty(&quot;name&quot;, name);&#10;                        record.addProperty(&quot;dosage&quot;, dosage);&#10;                        record.addProperty(&quot;unit&quot;, unit);&#10;                        record.addProperty(&quot;time&quot;, time);&#10;                        record.addProperty(&quot;date&quot;, date);&#10;                        record.addProperty(&quot;endDate&quot;, endDate);&#10;                        record.addProperty(&quot;repeatType&quot;, repeatType);&#10;                        record.addProperty(&quot;switchReminder&quot;, switchReminder != null ? switchReminder : false);&#10;&#10;                        medicationArray.add(record);&#10;&#10;                    }&#10;                    Log.d(&quot;Firestore&quot;, &quot;Loaded medications: &quot; + medicationArray);&#10;                })&#10;                .addOnFailureListener(e -&gt; Log.e(&quot;Firestore&quot;, &quot;Error loading meds&quot;, e));&#10;    }&#10;&#10;&#10;    private void callGemini(String prompt) {&#10;&#10;        runOnUiThread(() -&gt; loadingSpinner.setVisibility(View.VISIBLE)); // show spinner&#10;        new Thread(() -&gt; {&#10;            try {&#10;                // Build request JSON&#10;                JsonObject requestJson = new JsonObject();&#10;                JsonArray contents = new JsonArray();&#10;&#10;                JsonObject content = new JsonObject();&#10;                JsonArray parts = new JsonArray();&#10;                JsonObject part = new JsonObject();&#10;                part.addProperty(&quot;text&quot;, prompt);&#10;                parts.add(part);&#10;                content.add(&quot;parts&quot;, parts);&#10;&#10;                contents.add(content);&#10;                requestJson.add(&quot;contents&quot;, contents);&#10;&#10;                MediaType JSON = MediaType.parse(&quot;application/json; charset=utf-8&quot;);&#10;                RequestBody body = RequestBody.create(requestJson.toString(), JSON);&#10;&#10;                Request request = new Request.Builder()&#10;                        .url(GEMINI_URL)&#10;                        .post(body)&#10;                        .build();&#10;&#10;                Response response = client.newCall(request).execute();&#10;&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null) {&#10;                    String result = response.body().string();&#10;                    Log.d(&quot;Gemini&quot;, result);&#10;&#10;                    // Parse with Gson&#10;                    JsonObject json = new com.google.gson.JsonParser().parse(result).getAsJsonObject();&#10;                    String aiText = json.getAsJsonArray(&quot;candidates&quot;)&#10;                            .get(0).getAsJsonObject()&#10;                            .getAsJsonObject(&quot;content&quot;)&#10;                            .getAsJsonArray(&quot;parts&quot;)&#10;                            .get(0).getAsJsonObject()&#10;                            .get(&quot;text&quot;).getAsString();&#10;&#10;                    runOnUiThread(() -&gt; appendChat(&quot;AI: &quot; + aiText));&#10;                } else {&#10;                    runOnUiThread(() -&gt; appendChat(&quot;AI: API Error &quot; + response.code()));&#10;                }&#10;            } catch (Exception e) {&#10;                e.printStackTrace();&#10;                runOnUiThread(() -&gt; appendChat(&quot;AI: Exception - &quot; + e.getMessage()));&#10;            } finally {&#10;            runOnUiThread(() -&gt; loadingSpinner.setVisibility(View.GONE));&#10;            }&#10;        }).start();&#10;    }&#10;&#10;&#10;    private void appendChat(String message) {&#10;        chatHistory.append(message + &quot;\n\n&quot;);&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.elderlink.view_Ask_Ai;&#13;&#10;&#13;&#10;import android.content.Intent;&#13;&#10;import android.os.Bundle;&#13;&#10;import android.util.Log;&#13;&#10;import android.view.View;&#13;&#10;import android.widget.Button;&#13;&#10;import android.widget.EditText;&#13;&#10;import android.widget.ImageButton;&#13;&#10;import android.widget.ProgressBar;&#13;&#10;import android.widget.TextView;&#13;&#10;import android.widget.Toast;&#13;&#10;&#13;&#10;import androidx.appcompat.app.AppCompatActivity;&#13;&#10;&#13;&#10;import com.example.elderlink.MainActivityElder;&#13;&#10;import com.example.elderlink.R;&#13;&#10;import com.example.elderlink.BuildConfig;&#13;&#10;import com.google.firebase.firestore.FirebaseFirestore;&#13;&#10;import com.google.firebase.firestore.QueryDocumentSnapshot;&#13;&#10;import com.google.gson.JsonArray;&#13;&#10;import com.google.gson.JsonObject;&#13;&#10;&#13;&#10;import okhttp3.MediaType;&#13;&#10;import okhttp3.OkHttpClient;&#13;&#10;import okhttp3.Request;&#13;&#10;import okhttp3.RequestBody;&#13;&#10;import okhttp3.Response;&#13;&#10;&#13;&#10;public class ChatActivityElder extends AppCompatActivity {&#13;&#10;&#13;&#10;    FirebaseFirestore db;&#13;&#10;    JsonArray medicationArray = new JsonArray();&#13;&#10;&#13;&#10;    EditText inputMessage;&#13;&#10;    Button btnSend;&#13;&#10;    TextView chatHistory;&#13;&#10;    ProgressBar loadingSpinner;&#13;&#10;&#13;&#10;    // Debug here: Update URL possible for newer version of gemini&#13;&#10;    private static final String GEMINI_URL =&#13;&#10;            &quot;https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=&quot; + BuildConfig.GEMINI_API_KEY;&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;    OkHttpClient client = new OkHttpClient.Builder()&#13;&#10;            .connectTimeout(30, java.util.concurrent.TimeUnit.SECONDS) //Give 30s to connect to the API&#13;&#10;            .readTimeout(60, java.util.concurrent.TimeUnit.SECONDS)  //Up to 60s to read the response&#13;&#10;            .writeTimeout(60, java.util.concurrent.TimeUnit.SECONDS) //Up to 60s to upload data&#13;&#10;            .build();&#13;&#10;&#13;&#10;    @Override&#13;&#10;    protected void onCreate(Bundle savedInstanceState) {&#13;&#10;        super.onCreate(savedInstanceState);&#13;&#10;        setContentView(R.layout.activity_chat_elder);&#13;&#10;&#13;&#10;        db = FirebaseFirestore.getInstance();&#13;&#10;&#13;&#10;        inputMessage = findViewById(R.id.inputMessage);&#13;&#10;        btnSend = findViewById(R.id.btnSend);&#13;&#10;        chatHistory = findViewById(R.id.chatHistory);&#13;&#10;        loadingSpinner = findViewById(R.id.loadingSpinner);&#13;&#10;&#13;&#10;&#13;&#10;        // Get data from intent&#13;&#10;        String name = getIntent().getStringExtra(&quot;personName&quot;);&#13;&#10;        String imageBase64 = getIntent().getStringExtra(&quot;personImageBase64&quot;);&#13;&#10;        String personUid = getIntent().getStringExtra(&quot;personUid&quot;);&#13;&#10;        String uid = getIntent().getStringExtra(&quot;caregiverUid&quot;);&#13;&#10;        loadMedications(personUid);&#13;&#10;&#13;&#10;        btnSend.setOnClickListener(v -&gt; {&#13;&#10;            String userQuestion = inputMessage.getText().toString();&#13;&#10;            if (userQuestion.isEmpty()) return;&#13;&#10;&#13;&#10;            // Get today's date to help Ai know&#13;&#10;            String today = new java.text.SimpleDateFormat(&quot;yyyy-MM-dd&quot;, java.util.Locale.getDefault())&#13;&#10;                    .format(new java.util.Date());&#13;&#10;&#13;&#10;            appendChat(&quot;You: &quot; + userQuestion);&#13;&#10;&#13;&#10;            // Join all Firestore data into one string&#13;&#10;            String firestoreData = medicationArray.toString();&#13;&#10;&#13;&#10;            String prompt =&#13;&#10;                    &quot;You are a helpful and friendly medical assistant. &quot;&#13;&#10;                            + &quot;Today’s date is &quot; + today + &quot;. &quot;&#13;&#10;                            + &quot;You are given a list of medications in JSON format. &quot;&#13;&#10;                            + &quot;Each record may include: name, dosage, unit, time (24-hour format), date, endDate, repeatType, and switchReminder. &quot;&#13;&#10;                            + &quot;Answer the user’s question in a short, clear, and polite way.\n\n&quot;&#13;&#10;&#13;&#10;                            + &quot;JSON Data:\n&quot; + firestoreData + &quot;\n\n&quot;&#13;&#10;&#13;&#10;                            + &quot;User Question: &quot; + userQuestion + &quot;\n\n&quot;&#13;&#10;&#13;&#10;                            + &quot;Guidelines:\n&quot;&#13;&#10;                            + &quot;- Keep answers 1–3 sentences max.\n&quot;&#13;&#10;                            + &quot;- Be direct, but warm and supportive.\n&quot;&#13;&#10;                            + &quot;- If multiple medications apply, show them as a simple bullet list.\n&quot;&#13;&#10;                            + &quot;- For 'when' questions, always show both formats like: '14:00 (2:00 PM)'.\n&quot;&#13;&#10;                            + &quot;- For 'when' questions, use time/date/repeat info.\n&quot;&#13;&#10;                            + &quot;- For 'how much' questions, use dosage + unit.\n&quot;&#13;&#10;                            + &quot;- If the info isn’t in the data, say: 'I don’t know based on the data.'\n&quot;&#13;&#10;                            + &quot;- Never invent details not in the JSON.\n\n&quot;&#13;&#10;&#13;&#10;                            + &quot;Answer:&quot;;&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;            callGemini(prompt);&#13;&#10;            inputMessage.setText(&quot;&quot;);&#13;&#10;        });&#13;&#10;&#13;&#10;&#13;&#10;        //Back Button (to MainPage)------------------------------------------------&#13;&#10;        ImageButton btnBack = findViewById(R.id.btnBack);&#13;&#10;&#13;&#10;        btnBack.setOnClickListener(new View.OnClickListener() {&#13;&#10;            @Override&#13;&#10;            public void onClick(View v) {&#13;&#10;                Intent intent = new Intent(ChatActivityElder.this, MainActivityElder.class);&#13;&#10;                intent.putExtra(&quot;personUid&quot;, personUid);&#13;&#10;                intent.putExtra(&quot;personName&quot;, name);&#13;&#10;                intent.putExtra(&quot;personImageBase64&quot;, imageBase64);&#13;&#10;                intent.putExtra(&quot;caregiverUid&quot;, uid);&#13;&#10;                startActivity(intent);&#13;&#10;                finish();&#13;&#10;            }&#13;&#10;        });&#13;&#10;&#13;&#10;    }&#13;&#10;&#13;&#10;    private void loadMedications(String personUid) {&#13;&#10;        if (personUid == null || personUid.isEmpty()) {&#13;&#10;            Toast.makeText(this, &quot;No person specified.&quot;, Toast.LENGTH_LONG).show();&#13;&#10;            return;&#13;&#10;        }&#13;&#10;&#13;&#10;        String userUid = getIntent().getStringExtra(&quot;caregiverUid&quot;);   //convert caregiverUid to userUid, because must follow database structure&#13;&#10;&#13;&#10;        db.collection(&quot;users&quot;)&#13;&#10;                .document(userUid)&#13;&#10;                .collection(&quot;people&quot;)&#13;&#10;                .document(personUid)&#13;&#10;                .collection(&quot;medications&quot;)&#13;&#10;                .get()&#13;&#10;                .addOnSuccessListener(query -&gt; {&#13;&#10;                    for (QueryDocumentSnapshot doc : query) {&#13;&#10;                        String name = doc.getString(&quot;name&quot;);&#13;&#10;                        String dosage = doc.getString(&quot;dosage&quot;);&#13;&#10;                        String unit = doc.getString(&quot;unit&quot;);&#13;&#10;                        String time = doc.getString(&quot;time&quot;);&#13;&#10;                        String date = doc.getString(&quot;date&quot;);&#13;&#10;                        String endDate = doc.getString(&quot;endDate&quot;);&#13;&#10;                        String repeatType = doc.getString(&quot;repeatType&quot;);&#13;&#10;                        Boolean switchReminder = doc.getBoolean(&quot;switchReminder&quot;);&#13;&#10;&#13;&#10;                        // Build JSON-style record&#13;&#10;                        JsonObject record = new JsonObject();&#13;&#10;                        record.addProperty(&quot;id&quot;, doc.getId());&#13;&#10;                        record.addProperty(&quot;name&quot;, name);&#13;&#10;                        record.addProperty(&quot;dosage&quot;, dosage);&#13;&#10;                        record.addProperty(&quot;unit&quot;, unit);&#13;&#10;                        record.addProperty(&quot;time&quot;, time);&#13;&#10;                        record.addProperty(&quot;date&quot;, date);&#13;&#10;                        record.addProperty(&quot;endDate&quot;, endDate);&#13;&#10;                        record.addProperty(&quot;repeatType&quot;, repeatType);&#13;&#10;                        record.addProperty(&quot;switchReminder&quot;, switchReminder != null ? switchReminder : false);&#13;&#10;&#13;&#10;                        medicationArray.add(record);&#13;&#10;&#13;&#10;                    }&#13;&#10;                    Log.d(&quot;Firestore&quot;, &quot;Loaded medications: &quot; + medicationArray);&#13;&#10;                })&#13;&#10;                .addOnFailureListener(e -&gt; Log.e(&quot;Firestore&quot;, &quot;Error loading meds&quot;, e));&#13;&#10;    }&#13;&#10;&#13;&#10;&#13;&#10;    private void callGemini(String prompt) {&#13;&#10;&#13;&#10;        runOnUiThread(() -&gt; loadingSpinner.setVisibility(View.VISIBLE)); // show spinner&#13;&#10;        new Thread(() -&gt; {&#13;&#10;            try {&#13;&#10;                // Build request JSON&#13;&#10;                JsonObject requestJson = new JsonObject();&#13;&#10;                JsonArray contents = new JsonArray();&#13;&#10;&#13;&#10;                JsonObject content = new JsonObject();&#13;&#10;                JsonArray parts = new JsonArray();&#13;&#10;                JsonObject part = new JsonObject();&#13;&#10;                part.addProperty(&quot;text&quot;, prompt);&#13;&#10;                parts.add(part);&#13;&#10;                content.add(&quot;parts&quot;, parts);&#13;&#10;&#13;&#10;                contents.add(content);&#13;&#10;                requestJson.add(&quot;contents&quot;, contents);&#13;&#10;&#13;&#10;                MediaType JSON = MediaType.parse(&quot;application/json; charset=utf-8&quot;);&#13;&#10;                RequestBody body = RequestBody.create(requestJson.toString(), JSON);&#13;&#10;&#13;&#10;                Request request = new Request.Builder()&#13;&#10;                        .url(GEMINI_URL)&#13;&#10;                        .post(body)&#13;&#10;                        .build();&#13;&#10;&#13;&#10;                Response response = client.newCall(request).execute();&#13;&#10;&#13;&#10;                if (response.isSuccessful() &amp;&amp; response.body() != null) {&#13;&#10;                    String result = response.body().string();&#13;&#10;                    Log.d(&quot;Gemini&quot;, result);&#13;&#10;&#13;&#10;                    // Parse with Gson&#13;&#10;                    JsonObject json = new com.google.gson.JsonParser().parse(result).getAsJsonObject();&#13;&#10;                    String aiText = json.getAsJsonArray(&quot;candidates&quot;)&#13;&#10;                            .get(0).getAsJsonObject()&#13;&#10;                            .getAsJsonObject(&quot;content&quot;)&#13;&#10;                            .getAsJsonArray(&quot;parts&quot;)&#13;&#10;                            .get(0).getAsJsonObject()&#13;&#10;                            .get(&quot;text&quot;).getAsString();&#13;&#10;&#13;&#10;                    runOnUiThread(() -&gt; appendChat(&quot;AI: &quot; + aiText));&#13;&#10;                } else {&#13;&#10;                    runOnUiThread(() -&gt; appendChat(&quot;AI: API Error &quot; + response.code()));&#13;&#10;                }&#13;&#10;            } catch (Exception e) {&#13;&#10;                e.printStackTrace();&#13;&#10;                runOnUiThread(() -&gt; appendChat(&quot;AI: Exception - &quot; + e.getMessage()));&#13;&#10;            } finally {&#13;&#10;            runOnUiThread(() -&gt; loadingSpinner.setVisibility(View.GONE));&#13;&#10;            }&#13;&#10;        }).start();&#13;&#10;    }&#13;&#10;&#13;&#10;&#13;&#10;    private void appendChat(String message) {&#13;&#10;        chatHistory.append(message + &quot;\n\n&quot;);&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>